import{S as o,T as I,X as k,a as c,b as u,c as l,e as n,g as p,h as y,i as f,k as h}from"./chunk-MBWRPWEI.js";var m=class a{constructor(e,r){this.http=e;this.router=r}userSubject=new l(null);refreshTimer;URL="https://ezaszpkcccegxlhbcgpw.supabase.co";APIkey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6YXN6cGtjY2NlZ3hsaGJjZ3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NzI5MjEsImV4cCI6MjA3MTQ0ODkyMX0.CIVNnI1ZULLwVXUDhbyXajo8H32sPyXdriSqUcEyUNY";createUser(e,r){let t={email:e,password:r},i=new o({apikey:this.APIkey,Authorization:`Bearer ${this.APIkey}`,"Content-Type":"application/json"});return this.http.post(`${this.URL}/auth/v1/signup`,t,{headers:i})}login(e,r){let t={email:e,password:r},i=new o({apikey:this.APIkey,Authorization:`Bearer ${this.APIkey}`,"Content-Type":"application/json"});return this.http.post(`${this.URL}/auth/v1/token?grant_type=password`,t,{headers:i}).pipe(n(s=>({access_token:s.access_token,expires_at:s.expires_at,expires_in:s.expires_in,refresh_token:s.refresh_token,user_id:s.user.id})),p(s=>this.addRole(s)),y(s=>{localStorage.setItem("user",JSON.stringify(s))}))}logout(){localStorage.removeItem("user"),this.userSubject.next(null),this.router.navigate(["/"])}autologin(e){if(this.refreshTimer&&clearTimeout(this.refreshTimer),!e){let t=localStorage.getItem("user");if(t)e=JSON.parse(t),this.userSubject.next(e);else return}let r=e.expires_at*1e3-Date.now();r<=0?this.refreshToken(e.refresh_token).subscribe({next:t=>{localStorage.setItem("user",JSON.stringify(t)),this.userSubject.next(t)},error:()=>this.logout()}):this.refreshTimer=setTimeout(()=>{this.refreshToken(e.refresh_token).subscribe({next:t=>{localStorage.setItem("user",JSON.stringify(t)),this.userSubject.next(t)},error:()=>this.logout()})},r)}refreshToken(e){let r={refresh_token:e},t=new o({apikey:this.APIkey,Authorization:`Bearer ${this.APIkey}`,"Content-Type":"application/json"});return this.http.post(`${this.URL}/auth/v1/token?grant_type=refresh_token`,r,{headers:t}).pipe(n(i=>({access_token:i.access_token,expires_at:i.expires_at,expires_in:i.expires_in,refresh_token:i.refresh_token,user_id:i.user.id})),p(i=>this.addRole(i)))}addRole(e){let r=new o({apikey:this.APIkey,Authorization:`Bearer ${e.access_token}`,"Content-Type":"application/json"});return this.http.get(`${this.URL}/rest/v1/user_roles?select=role&user_id=eq.${e.user_id}`,{headers:r}).pipe(n(t=>{let i=t.length>0?t[0].role:null;return u(c({},e),{role:i})}))}static \u0275fac=function(r){return new(r||a)(h(I),h(k))};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})};export{m as a};
